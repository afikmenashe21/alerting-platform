# rule-service/internal/database
internal/database/database_test.go:13:2: missing go.sum entry for module providing package github.com/DATA-DOG/go-sqlmock (imported by rule-service/internal/database); to add:
	go get -t rule-service/internal/database
FAIL	rule-service/internal/database [setup failed]
# rule-service/internal/handlers
internal/database/database_test.go:13:2: missing go.sum entry for module providing package github.com/DATA-DOG/go-sqlmock (imported by rule-service/internal/database); to add:
	go get -t rule-service/internal/database
FAIL	rule-service/internal/handlers [setup failed]
?   	rule-service/cmd/rule-service	[no test files]
=== RUN   TestConfig_Validate
=== RUN   TestConfig_Validate/valid_config
=== RUN   TestConfig_Validate/empty_http-port
=== RUN   TestConfig_Validate/empty_kafka-brokers
=== RUN   TestConfig_Validate/empty_rule-changed-topic
=== RUN   TestConfig_Validate/empty_postgres-dsn
=== RUN   TestConfig_Validate/all_fields_empty
--- PASS: TestConfig_Validate (0.00s)
    --- PASS: TestConfig_Validate/valid_config (0.00s)
    --- PASS: TestConfig_Validate/empty_http-port (0.00s)
    --- PASS: TestConfig_Validate/empty_kafka-brokers (0.00s)
    --- PASS: TestConfig_Validate/empty_rule-changed-topic (0.00s)
    --- PASS: TestConfig_Validate/empty_postgres-dsn (0.00s)
    --- PASS: TestConfig_Validate/all_fields_empty (0.00s)
PASS
ok  	rule-service/internal/config	(cached)
=== RUN   TestRuleChanged_JSONMarshaling
=== RUN   TestRuleChanged_JSONMarshaling/CREATED_action
=== RUN   TestRuleChanged_JSONMarshaling/UPDATED_action
=== RUN   TestRuleChanged_JSONMarshaling/DELETED_action
=== RUN   TestRuleChanged_JSONMarshaling/DISABLED_action
--- PASS: TestRuleChanged_JSONMarshaling (0.00s)
    --- PASS: TestRuleChanged_JSONMarshaling/CREATED_action (0.00s)
    --- PASS: TestRuleChanged_JSONMarshaling/UPDATED_action (0.00s)
    --- PASS: TestRuleChanged_JSONMarshaling/DELETED_action (0.00s)
    --- PASS: TestRuleChanged_JSONMarshaling/DISABLED_action (0.00s)
=== RUN   TestActionConstants
--- PASS: TestActionConstants (0.00s)
PASS
ok  	rule-service/internal/events	(cached)
=== RUN   TestNewProducer
=== RUN   TestNewProducer/empty_brokers
=== RUN   TestNewProducer/empty_topic
=== RUN   TestNewProducer/valid_config
2026/01/18 12:02:13 INFO Initializing Kafka producer brokers=[localhost:9092] topic=rule.changed
2026/01/18 12:02:13 WARN Could not connect to Kafka to check/create topic broker=localhost:9092 topic=rule.changed error="failed to dial: failed to open connection to localhost:9092: dial tcp [::1]:9092: connect: connection refused" note="Topic may need to be created manually"
2026/01/18 12:02:13 INFO Kafka producer configured write_timeout=10s required_acks=RequireOne async=false balancer="Hash (key-based partitioning)" partition_key="rule_id (hashed)"
2026/01/18 12:02:13 INFO Closing Kafka producer topic=rule.changed
2026/01/18 12:02:13 INFO Kafka producer closed successfully
=== RUN   TestNewProducer/multiple_brokers
2026/01/18 12:02:13 INFO Initializing Kafka producer brokers="[localhost:9092 localhost:9093]" topic=rule.changed
2026/01/18 12:02:13 WARN Could not connect to Kafka to check/create topic broker=localhost:9092 topic=rule.changed error="failed to dial: failed to open connection to localhost:9092: dial tcp [::1]:9092: connect: connection refused" note="Topic may need to be created manually"
2026/01/18 12:02:13 INFO Kafka producer configured write_timeout=10s required_acks=RequireOne async=false balancer="Hash (key-based partitioning)" partition_key="rule_id (hashed)"
2026/01/18 12:02:13 INFO Closing Kafka producer topic=rule.changed
2026/01/18 12:02:13 INFO Kafka producer closed successfully
=== RUN   TestNewProducer/brokers_with_spaces
2026/01/18 12:02:13 INFO Initializing Kafka producer brokers="[localhost:9092 localhost:9093]" topic=rule.changed
2026/01/18 12:02:13 WARN Could not connect to Kafka to check/create topic broker=localhost:9092 topic=rule.changed error="failed to dial: failed to open connection to localhost:9092: dial tcp [::1]:9092: connect: connection refused" note="Topic may need to be created manually"
2026/01/18 12:02:13 INFO Kafka producer configured write_timeout=10s required_acks=RequireOne async=false balancer="Hash (key-based partitioning)" partition_key="rule_id (hashed)"
2026/01/18 12:02:13 INFO Closing Kafka producer topic=rule.changed
2026/01/18 12:02:13 INFO Kafka producer closed successfully
--- PASS: TestNewProducer (0.00s)
    --- PASS: TestNewProducer/empty_brokers (0.00s)
    --- PASS: TestNewProducer/empty_topic (0.00s)
    --- PASS: TestNewProducer/valid_config (0.00s)
    --- PASS: TestNewProducer/multiple_brokers (0.00s)
    --- PASS: TestNewProducer/brokers_with_spaces (0.00s)
=== RUN   TestProducer_Close
2026/01/18 12:02:13 INFO Initializing Kafka producer brokers=[localhost:9092] topic=rule.changed
2026/01/18 12:02:13 WARN Could not connect to Kafka to check/create topic broker=localhost:9092 topic=rule.changed error="failed to dial: failed to open connection to localhost:9092: dial tcp [::1]:9092: connect: connection refused" note="Topic may need to be created manually"
2026/01/18 12:02:13 INFO Kafka producer configured write_timeout=10s required_acks=RequireOne async=false balancer="Hash (key-based partitioning)" partition_key="rule_id (hashed)"
2026/01/18 12:02:13 INFO Closing Kafka producer topic=rule.changed
2026/01/18 12:02:13 INFO Kafka producer closed successfully
2026/01/18 12:02:13 INFO Closing Kafka producer topic=rule.changed
2026/01/18 12:02:13 INFO Kafka producer closed successfully
--- PASS: TestProducer_Close (0.00s)
=== RUN   TestProducer_Publish
2026/01/18 12:02:13 INFO Initializing Kafka producer brokers=[localhost:9092] topic=rule.changed
2026/01/18 12:02:13 WARN Could not connect to Kafka to check/create topic broker=localhost:9092 topic=rule.changed error="failed to dial: failed to open connection to localhost:9092: dial tcp [::1]:9092: connect: connection refused" note="Topic may need to be created manually"
2026/01/18 12:02:13 INFO Kafka producer configured write_timeout=10s required_acks=RequireOne async=false balancer="Hash (key-based partitioning)" partition_key="rule_id (hashed)"
2026/01/18 12:02:13 ERROR Failed to write message to Kafka rule_id=rule-1 topic=rule.changed error="dial tcp [::1]:9092: connect: connection refused"
    producer_test.go:165: Skipping Publish tests: Kafka not available: failed to write message to Kafka: dial tcp [::1]:9092: connect: connection refused
2026/01/18 12:02:13 INFO Closing Kafka producer topic=rule.changed
2026/01/18 12:02:13 INFO Kafka producer closed successfully
--- SKIP: TestProducer_Publish (0.00s)
=== RUN   TestProducer_Publish_ContextCancellation
2026/01/18 12:02:13 INFO Initializing Kafka producer brokers=[localhost:9092] topic=rule.changed
2026/01/18 12:02:13 WARN Could not connect to Kafka to check/create topic broker=localhost:9092 topic=rule.changed error="failed to dial: failed to open connection to localhost:9092: dial tcp [::1]:9092: connect: connection refused" note="Topic may need to be created manually"
2026/01/18 12:02:13 INFO Kafka producer configured write_timeout=10s required_acks=RequireOne async=false balancer="Hash (key-based partitioning)" partition_key="rule_id (hashed)"
2026/01/18 12:02:13 ERROR Failed to write message to Kafka rule_id=rule-1 topic=rule.changed error="dial tcp [::1]:9092: connect: connection refused"
2026/01/18 12:02:13 INFO Closing Kafka producer topic=rule.changed
2026/01/18 12:02:13 INFO Kafka producer closed successfully
--- PASS: TestProducer_Publish_ContextCancellation (0.00s)
=== RUN   TestCreateTopicIfNotExists
2026/01/18 12:02:13 INFO Initializing Kafka producer brokers=[localhost:9092] topic=test-topic-creation
2026/01/18 12:02:13 WARN Could not connect to Kafka to check/create topic broker=localhost:9092 topic=test-topic-creation error="failed to dial: failed to open connection to localhost:9092: dial tcp [::1]:9092: connect: connection refused" note="Topic may need to be created manually"
2026/01/18 12:02:13 INFO Kafka producer configured write_timeout=10s required_acks=RequireOne async=false balancer="Hash (key-based partitioning)" partition_key="rule_id (hashed)"
2026/01/18 12:02:13 INFO Closing Kafka producer topic=test-topic-creation
2026/01/18 12:02:13 INFO Kafka producer closed successfully
--- PASS: TestCreateTopicIfNotExists (0.00s)
PASS
ok  	rule-service/internal/producer	0.424s
=== RUN   TestNewRouter
--- PASS: TestNewRouter (0.00s)
=== RUN   TestRouter_Handler
--- PASS: TestRouter_Handler (0.00s)
=== RUN   TestRouter_HealthCheck
--- PASS: TestRouter_HealthCheck (0.00s)
=== RUN   TestNewServer
--- PASS: TestNewServer (0.00s)
=== RUN   TestRouter_Routes
=== RUN   TestRouter_Routes/clients_POST
=== RUN   TestRouter_Routes/clients_GET
--- FAIL: TestRouter_Routes (0.00s)
    --- PASS: TestRouter_Routes/clients_POST (0.00s)
    --- FAIL: TestRouter_Routes/clients_GET (0.00s)
panic: runtime error: invalid memory address or nil pointer dereference [recovered, repanicked]
[signal SIGSEGV: segmentation violation code=0x2 addr=0x0 pc=0x102b44328]

goroutine 13 [running]:
testing.tRunner.func1.2({0x102d0b7c0, 0x102ff75c0})
	/usr/local/go/src/testing/testing.go:1872 +0x190
testing.tRunner.func1()
	/usr/local/go/src/testing/testing.go:1875 +0x31c
panic({0x102d0b7c0?, 0x102ff75c0?})
	/usr/local/go/src/runtime/panic.go:783 +0x120
database/sql.(*DB).conn(0x5?, {0x102d8b848?, 0x103033b40?}, 0xc9?)
	/usr/local/go/src/database/sql/sql.go:1317 +0x28
database/sql.(*DB).query(0x0, {0x102d8b848, 0x103033b40}, {0x102c3d6fe, 0x5d}, {0x0, 0x0, 0x0}, 0x8?)
	/usr/local/go/src/database/sql/sql.go:1759 +0x40
database/sql.(*DB).QueryContext.func1(0x0?)
	/usr/local/go/src/database/sql/sql.go:1742 +0x40
database/sql.(*DB).retry(0x1400010bb68?, 0x1400015fb10)
	/usr/local/go/src/database/sql/sql.go:1576 +0x4c
database/sql.(*DB).QueryContext(0x1400010bbb8?, {0x102d8b848?, 0x103033b40?}, {0x102c3d6fe?, 0x1400010bbb8?}, {0x0?, 0x1400010bbc0?, 0x5d755af002b3b324?})
	/usr/local/go/src/database/sql/sql.go:1741 +0x80
rule-service/internal/database.(*DB).ListClients(0x50000000b?, {0x102d8b848?, 0x103033b40?})
	/Users/afikmenashe/alerting-platform/services/rule-service/internal/database/database.go:154 +0x5c
rule-service/internal/handlers.(*Handlers).ListClients(0xa01971110f0efae7?, {0x102d8b458, 0x140002169c0}, 0x102cf64e0?)
	/Users/afikmenashe/alerting-platform/services/rule-service/internal/handlers/handlers.go:98 +0xa8
rule-service/internal/router.(*Router).setupRoutes.func1({0x102d8b458, 0x140002169c0}, 0x14000230500)
	/Users/afikmenashe/alerting-platform/services/rule-service/internal/router/router.go:39 +0xac
net/http.HandlerFunc.ServeHTTP(0x140001303c0?, {0x102d8b458?, 0x140002169c0?}, 0x1c?)
	/usr/local/go/src/net/http/server.go:2322 +0x38
net/http.(*ServeMux).ServeHTTP(0x14000213950?, {0x102d8b458, 0x140002169c0}, 0x14000230500)
	/usr/local/go/src/net/http/server.go:2861 +0x190
rule-service/internal/router.TestRouter_Routes.(*Router).Handler.corsMiddleware.func2({0x102d8b458, 0x140002169c0}, 0x14000230500)
	/Users/afikmenashe/alerting-platform/services/rule-service/internal/router/router.go:166 +0x128
net/http.HandlerFunc.ServeHTTP(...)
	/usr/local/go/src/net/http/server.go:2322
rule-service/internal/router.TestRouter_Routes.func1(0x14000224700)
	/Users/afikmenashe/alerting-platform/services/rule-service/internal/router/router_test.go:141 +0xe8
testing.tRunner(0x14000224700, 0x14000226aa0)
	/usr/local/go/src/testing/testing.go:1934 +0xc8
created by testing.(*T).Run in goroutine 11
	/usr/local/go/src/testing/testing.go:1997 +0x364
FAIL	rule-service/internal/router	0.740s
FAIL
